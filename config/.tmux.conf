# ==============================================================================
# TMUX CONFIGURATION - AGNOSTIC & HARDENED
# ==============================================================================
# This configuration enables dynamic network monitoring, automatic pane logging,
# and accurate terminal command capturing via 'ansi2png'.
# ==============================================================================

# --- Environment Initialization ---
# Ensure network monitor is executable and running in the background.
# This script tracks public/local IP changes for the status bar.
run-shell -b "chmod +x $HOME/.tmux/tmux_net_monitor.sh; $HOME/.tmux/tmux_net_monitor.sh >/dev/null 2>&1"

# --- Terminal Hardening ---
# Set 256color support and enable TrueColor (RGB) for accurate rendering.
set -g default-terminal "tmux-256color"
set -as terminal-features ",xterm-256color:RGB"
set -g mouse on
set -as terminal-overrides ',xterm*:smcup@:rmcup@'

# --- Global Settings ---
set -g history-limit 100000
set -s escape-time 0                 # Remove delay for escape sequences (crucial for Vim/VTE)
set -g focus-events on
setw -g aggressive-resize on

# --- Status Bar ---
# Interval: 5 seconds (balance between responsiveness and CPU usage)
set -g status-interval 5
set -g status-style "bg=default,fg=default"
set -g status-right-length 180

# Dynamic status line:
#   L: Local IP (Primary interface)
#   P: Public IP (Resolved via DNS TXT record in SHM)
set -g status-right "#[fg=brightwhite]L: #[fg=brightyellow]#(ip -4 addr show | grep -vE 'host|docker|veth|br-' | awk '/inet / {print $2}' | cut -d/ -f1 | head -n 1) #[fg=brightwhite]| P: #[fg=brightcyan]#(cat /dev/shm/tmux_${USER}/public_ip 2>/dev/null || echo 'Syncing...') #[fg=brightwhite]| #[fg=brightgreen]%m.%d.%Y #[fg=brightwhite]%I:%M %p #[fg=brightyellow]%Z "

# --- Clipboard & Logging ---
set -s set-clipboard on
setw -g mode-keys vi

# Dynamic Copy Command: Detects Wayland vs X11 for clipboard synchronization.
%hidden COPY_CMD='if [ -n "$WAYLAND_DISPLAY" ]; then wl-copy; else xclip -selection clipboard -i; fi'

bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "$COPY_CMD"
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "$COPY_CMD"

# Dynamic Logging Hooks:
# Hooks into pane creation/splits to start 'tmux_logger.sh'.
# ID format: Session-Window-Pane-Date (slashes replaced with dashes).
%hidden LOGGER_CMD='ID=$(echo "#S-#W-#P-%D" | sed "s/\//-/g"); exec bash $HOME/.tmux/tmux_logger.sh $HOME/.tmux/logs "$ID"'
set-hook -g after-split-window "pipe-pane -o '$LOGGER_CMD'"
set-hook -g after-new-window   "pipe-pane -o '$LOGGER_CMD'"
set-hook -g after-new-session  "pipe-pane -o '$LOGGER_CMD'"

# --- Controls ---
bind r source-file ~/.tmux.conf \; display "Config Reloaded for ${USER}"
bind M set -g mouse on \; display "Mouse Mode RE-ARMED"

# --- Custom Tools ---
# Capture last command to PNG:
# Uses 'ansi2png' to parse the current pane's log and render a high-quality PNG.
bind-key S run-shell "ansi2png --log-dir $HOME/.tmux/logs --screenshot-dir $HOME/.tmux/screenshots --debug-log $HOME/.tmux/ansi2png.debug.log && tmux display-message 'Screenshot saved to ~/.tmux/screenshots/'"

# List command history for capture:
# Displays a popup with a list of historical commands with timestamps and UUIDs.
bind-key H display-popup -E "ansi2png --log-dir $HOME/.tmux/logs --list | less -R"
